<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Analyse avancée de sondage PDF</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
body{font-family:Arial;background:#f4f6f8;padding:30px}
.container{max-width:1100px;margin:auto;background:#fff;padding:25px;border-radius:10px}
textarea{width:100%;height:90px}
button{padding:10px 16px;background:#007bff;color:#fff;border:0;border-radius:5px;cursor:pointer}
.results{display:flex;justify-content:space-around;margin-top:25px}
.card{background:#f1f3f5;padding:15px;border-radius:8px;width:22%;text-align:center}
canvas{max-width:420px;margin:30px auto}
</style>
</head>
<body>
<div class="container">
<h1>Analyse avancée – Maisons closes</h1>
<input type="file" id="pdfInput" accept="application/pdf"><br><br>
<h3>Mots-clés POUR</h3><textarea id="pour"></textarea>
<h3>POUR sous conditions</h3><textarea id="cond"></textarea>
<h3>CONTRE</h3><textarea id="contre"></textarea><br><br>
<button onclick="analyze()">Analyser</button>
<h2>Réponses analysées : <span id="count">0</span></h2>
<div class="results">
<div class="card">POUR<br><span id="r_pour">0</span></div>
<div class="card">CONDITIONNEL<br><span id="r_cond">0</span></div>
<div class="card">CONTRE<br><span id="r_contre">0</span></div>
<div class="card">NEUTRE<br><span id="r_neutre">0</span></div>
</div>
<canvas id="chart"></canvas>
</div>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
let keywords={pour:[],cond:[],contre:[]};
fetch('keywords.json').then(r=>r.json()).then(j=>{keywords=j;sync()});
function sync(){pour.value=keywords.pour.join('\n');cond.value=keywords.cond.join('\n');contre.value=keywords.contre.join('\n');}
function norm(t){return t.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();}
async function extract(file){const pdf=await pdfjsLib.getDocument(await file.arrayBuffer()).promise;let txt='';for(let i=1;i<=pdf.numPages;i++){const p=await pdf.getPage(i);const c=await p.getTextContent();c.items.forEach(it=>txt+=it.str+' ');}return norm(txt)}
function countMatches(t,list){return list.reduce((s,k)=>s+(t.includes(norm(k))?1:0),0)}
function classify(t){const p=countMatches(t,keywords.pour);const c=countMatches(t,keywords.cond);const n=countMatches(t,keywords.contre);if(n>p&&n>0)return'contre';if(p>0&&c>0)return'cond';if(p>0)return'pour';return'neutre'}
let chart;
async function analyze(){keywords.pour=pour.value.split('\n').filter(Boolean);keywords.cond=cond.value.split('\n').filter(Boolean);keywords.contre=contre.value.split('\n').filter(Boolean);const file=pdfInput.files[0];if(!file)return;const text=await extract(file);const opinions=text.split(/@[a-z0-9.-]+/).filter(t=>t.length>20);let r={pour:0,cond:0,contre:0,neutre:0};opinions.forEach(o=>r[classify(o)]++);count.innerText=opinions.length;r_pour.innerText=r.pour;r_cond.innerText=r.cond;r_contre.innerText=r.contre;r_neutre.innerText=r.neutre;if(chart)chart.destroy();chart=new Chart(chart,{type:'pie',data:{labels:['POUR','COND','CONTRE','NEUTRE'],datasets:[{data:Object.values(r)}]}})}
</script>
</body>
</html>
