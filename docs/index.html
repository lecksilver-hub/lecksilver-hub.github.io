<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Analyseur de sondage PDF</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            padding: 40px;
        }
        h1, h2 { text-align: center; }

        .container {
            max-width: 1000px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }

        .block { margin-bottom: 25px; }

        textarea {
            width: 100%;
            height: 90px;
            padding: 10px;
        }

        button {
            background: #007bff;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        .results {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
        }

        .card {
            background: #f1f3f5;
            padding: 20px;
            border-radius: 8px;
            width: 22%;
            text-align: center;
        }

        canvas {
            max-width: 400px;
            margin: 30px auto;
            display: block;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Analyse de sondage ‚Äì Maisons closes</h1>

    <div class="block">
        <h3>1Ô∏è‚É£ Importer le fichier PDF</h3>
        <input type="file" id="pdfInput" accept="application/pdf" />
    </div>

    <div class="block">
        <h3>2Ô∏è‚É£ Mots-cl√©s POUR</h3>
        <textarea id="pourKeywords"></textarea>
    </div>

    <div class="block">
        <h3>3Ô∏è‚É£ Mots-cl√©s POUR SOUS CONDITIONS</h3>
        <textarea id="conditionalKeywords"></textarea>
    </div>

    <div class="block">
        <h3>4Ô∏è‚É£ Mots-cl√©s CONTRE</h3>
        <textarea id="contreKeywords"></textarea>
    </div>

    <div class="block">
        <button onclick="analyze()">üìä Lancer l‚Äôanalyse</button>
        <button onclick="resetKeywords()">üîÑ R√©initialiser</button>
    </div>

    <h2>üë• Personnes analys√©es : <span id="count">0</span></h2>

    <div class="results">
        <div class="card"><h3>‚úÖ POUR</h3><p id="pourResult">0 %</p></div>
        <div class="card"><h3>üü¶ POUR (conditions)</h3><p id="conditionalResult">0 %</p></div>
        <div class="card"><h3>‚ùå CONTRE</h3><p id="contreResult">0 %</p></div>
        <div class="card"><h3>‚öñÔ∏è NEUTRE</h3><p id="neutralResult">0 %</p></div>
    </div>

    <canvas id="chart"></canvas>
</div>

<script>
/* =========================
   KEYWORDS STATE
========================= */
let keywords = {
    pour: [],
    conditional: [
        "a condition",
        "sous condition",
        "mais",
        "si"
    ],
    contre: []
};

/* =========================
   LOAD keyword.json
========================= */
async function loadKeywords() {
    try {
        const res = await fetch("keyword.json", { cache: "no-store" });
        if (!res.ok) throw new Error("keyword.json introuvable");
        const json = await res.json();

        if (!json.pour || !json.contre) throw new Error("JSON invalide");

        keywords.pour = json.pour;
        keywords.contre = json.contre;

        syncTextareas();
        localStorage.setItem("keywords", JSON.stringify(keywords));
        console.info("keyword.json charg√©");
    } catch {
        const saved = localStorage.getItem("keywords");
        if (saved) {
            keywords = JSON.parse(saved);
            syncTextareas();
        } else {
            console.warn("Aucun keyword.json trouv√©, mots-cl√©s vides");
        }
    }
}

/* =========================
   UI SYNC
========================= */
function syncTextareas() {
    pourKeywords.value = keywords.pour.join("\n");
    conditionalKeywords.value = keywords.conditional.join("\n");
    contreKeywords.value = keywords.contre.join("\n");
}

/* =========================
   UTILS
========================= */
function normalizeText(text) {
    return text.normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[‚Äô‚Äò`]/g, "'")
        .replace(/[^\w\s'-]/g, "")
        .toLowerCase();
}

/* =========================
   PDF EXTRACTION
========================= */
async function extractTextFromPDF(file) {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
    let text = "";

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        content.items.forEach(item => text += item.str + " ");
    }

    pdf.cleanup();
    pdf.destroy();
    return normalizeText(text);
}

/* =========================
   SCORING & CLASSIFICATION
========================= */
function score(text, list) {
    let s = 0;
    list.forEach(k => {
        const r = new RegExp(`\\b${normalizeText(k)}\\b`, "g");
        const m = text.match(r);
        if (m) s += m.length;
    });
    return s;
}

function classify(text) {
    const p = score(text, keywords.pour);
    const c = score(text, keywords.conditional);
    const n = score(text, keywords.contre);

    if (n > 0 && n >= p) return "contre";
    if (p > 0 && c > 0) return "conditional";
    if (p > 0) return "pour";
    return "neutre";
}

/* =========================
   ANALYSE
========================= */
let chartInstance = null;

async function analyze() {
    const file = pdfInput.files[0];
    if (!file) return alert("S√©lectionne un PDF");

    // synchro UI -> state
    keywords.pour = pourKeywords.value.split("\n").filter(Boolean);
    keywords.conditional = conditionalKeywords.value.split("\n").filter(Boolean);
    keywords.contre = contreKeywords.value.split("\n").filter(Boolean);
    localStorage.setItem("keywords", JSON.stringify(keywords));

    const text = await extractTextFromPDF(file);
    const opinions = text.split(/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}/);

    let r = { pour: 0, conditional: 0, contre: 0, neutre: 0 };
    opinions.forEach(o => {
        if (o.trim().length > 10) r[classify(o)]++;
    });

    const total = Object.values(r).reduce((a,b)=>a+b,0);
    count.innerText = total;

    pourResult.innerText = ((r.pour/total)*100).toFixed(1)+" %";
    conditionalResult.innerText = ((r.conditional/total)*100).toFixed(1)+" %";
    contreResult.innerText = ((r.contre/total)*100).toFixed(1)+" %";
    neutralResult.innerText = ((r.neutre/total)*100).toFixed(1)+" %";

    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(chart, {
        type: "pie",
        data: {
            labels: ["POUR", "POUR (conditions)", "CONTRE", "NEUTRE"],
            datasets: [{ data: [r.pour, r.conditional, r.contre, r.neutre] }]
        }
    });

    pdfInput.value = "";
}

/* =========================
   RESET
========================= */
function resetKeywords() {
    localStorage.removeItem("keywords");
    location.reload();
}

// üöÄ init
loadKeywords();
</script>

</body>
</html>
