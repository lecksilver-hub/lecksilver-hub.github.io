<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Analyse avancée de sondage PDF</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f4f6f8;--card:#ffffff;--primary:#2563eb;--green:#16a34a;--red:#dc2626;--orange:#f59e0b;--muted:#6b7280;
}
*{box-sizing:border-box}
body{font-family:Inter,Arial;background:var(--bg);padding:40px;color:#111827}
.container{max-width:1150px;margin:auto;background:var(--card);padding:35px;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
h1{text-align:center;font-size:28px;margin-bottom:30px}
h3{margin:18px 0 8px}
input[type=file]{padding:12px;border:2px dashed #c7d2fe;border-radius:12px;width:100%}
textarea{width:100%;height:90px;padding:12px;border-radius:10px;border:1px solid #d1d5db;font-family:Inter}
button{margin-top:15px;padding:12px 22px;background:var(--primary);color:white;border:0;border-radius:12px;font-weight:600;cursor:pointer}
button:hover{opacity:.9}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-top:30px}
.card{padding:22px;border-radius:16px;text-align:center;font-size:18px;font-weight:600}
.pour{background:#dcfce7;color:#166534}
.cond{background:#dbeafe;color:#1e40af}
.contre{background:#fee2e2;color:#7f1d1d}
.neutre{background:#ffedd5;color:#9a3412}
.card span{display:block;font-size:32px;margin-top:8px}
canvas{max-width:420px;margin:40px auto 0}
.footer{text-align:center;color:var(--muted);margin-top:20px;font-size:13px}
</style>
</head>
<body>
<div class="container">
<h1>Analyse avancée – Maisons closes</h1>
<input type="file" id="pdfInput" accept="application/pdf">
<h3>Mots-clés POUR</h3><textarea id="pour"></textarea>
<h3>POUR sous conditions</h3><textarea id="cond"></textarea>
<h3>CONTRE</h3><textarea id="contre"></textarea>
<button onclick="analyze()">Analyser le PDF</button>
<h2 style="margin-top:25px;text-align:center">Réponses analysées : <span id="count">0</span></h2>
<div class="stats">
<div class="card pour">POUR<span id="r_pour">0</span></div>
<div class="card cond">CONDITIONNEL<span id="r_cond">0</span></div>
<div class="card contre">CONTRE<span id="r_contre">0</span></div>
<div class="card neutre">NEUTRE<span id="r_neutre">0</span></div>
</div>
<canvas id="chart"></canvas>
<div class="footer">Analyse locale – aucune donnée envoyée</div>
</div>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
let keywords={pour:[],cond:[],contre:[]};
fetch('keywords.json',{cache:'no-store'}).then(r=>r.json()).then(j=>{keywords=j;sync()});
function sync(){pour.value=keywords.pour.join('\n');cond.value=keywords.cond.join('\n');contre.value=keywords.contre.join('\n');}
function norm(t){return t.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z\s]/gi,' ').toLowerCase();}
async function extract(file){const pdf=await pdfjsLib.getDocument(await file.arrayBuffer()).promise;let txt='';for(let i=1;i<=pdf.numPages;i++){const p=await pdf.getPage(i);const c=await p.getTextContent();c.items.forEach(it=>txt+=it.str+' ');}return norm(txt)}
function countMatches(t,list){let score=0;list.forEach(k=>{const r=new RegExp('\\b'+norm(k)+'\\b','g');const m=t.match(r);if(m)score+=m.length});return score}
function classify(t){const p=countMatches(t,keywords.pour);const c=countMatches(t,keywords.cond);const n=countMatches(t,keywords.contre);if(n>p&&n>0)return'contre';if(p>0&&c>0)return'cond';if(p>0)return'pour';return'neutre'}
let chartInstance;
async function analyze(){keywords.pour=pour.value.split('\n').filter(l=>l.trim().length>2);keywords.cond=cond.value.split('\n').filter(l=>l.trim().length>2);keywords.contre=contre.value.split('\n').filter(l=>l.trim().length>2);const file=pdfInput.files[0];if(!file)return;const text=await extract(file);
// découpe robuste : une réponse commence après un email et se termine avant le suivant
const parts=text.split(/\b[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}\b/).map(t=>t.trim()).filter(t=>t.length>25);
let r={pour:0,cond:0,contre:0,neutre:0};parts.forEach(o=>r[classify(o)]++);
count.innerText=parts.length;r_pour.innerText=r.pour;r_cond.innerText=r.cond;r_contre.innerText=r.contre;r_neutre.innerText=r.neutre;
if(chartInstance) chartInstance.destroy();chartInstance=new Chart(document.getElementById('chart'),{type:'pie',data:{labels:['POUR','CONDITIONNEL','CONTRE','NEUTRE'],datasets:[{data:[r.pour,r.cond,r.contre,r.neutre],backgroundColor:['#16a34a','#2563eb','#dc2626','#f59e0b']}],options:{responsive:true,maintainAspectRatio:false}})}
</script>
</body>
</html>
